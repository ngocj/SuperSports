@model SP.Application.Dto.ProductVariantDto.VariantCreateDto
@{
    ViewData["Title"] = "Create Product Variant";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

<div class="container py-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Thêm biến thể sản phẩm</h3>
                </div>
                <div class="card-body">
                    <form asp-action="CreateProductVariant" method="post" enctype="multipart/form-data">
                        <input type="hidden" asp-for="ProductId" />

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Color" class="form-label fw-bold">Màu sắc</label>
                                    <select asp-for="Color" class="form-select" id="colorSelect">
                                        <option value="">Chọn màu</option>
                                        <option value="Black">Đen</option>
                                        <option value="White">Trắng</option>
                                        <option value="Red">Đỏ</option>
                                        <option value="Blue">Xanh dương</option>
                                        <option value="Green">Xanh lá</option>
                                        <option value="Yellow">Vàng</option>
                                        <option value="Purple">Tím</option>
                                        <option value="Orange">Cam</option>
                                        <option value="Pink">Hồng</option>
                                        <option value="Gray">Xám</option>
                                        <option value="Brown">Nâu</option>
                                    </select>
                                    <span asp-validation-for="Color" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Size" class="form-label fw-bold">Kích cỡ</label>
                                    <select asp-for="Size" class="form-select" id="sizeSelect">
                                        <option value="">Chọn kích cỡ</option>
                                        <!-- Quần áo -->
                                        <option value="XS">XS</option>
                                        <option value="S">S</option>
                                        <option value="M">M</option>
                                        <option value="L">L</option>
                                        <option value="XL">XL</option>
                                        <option value="XXL">XXL</option>
                                        <option value="XXXL">XXXL</option>
                                        <option value="4XL">4XL</option>
                                        <option value="5XL">5XL</option>
                                        <!-- Giày dép -->
                                        <option value="35">35</option>
                                        <option value="36">36</option>
                                        <option value="37">37</option>
                                        <option value="38">38</option>
                                        <option value="39">39</option>
                                        <option value="40">40</option>
                                        <option value="41">41</option>
                                        <option value="42">42</option>
                                        <option value="43">43</option>
                                        <option value="44">44</option>
                                        <option value="45">45</option>
                                    </select>
                                    <span asp-validation-for="Size" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Price" class="form-label fw-bold">Giá</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input asp-for="Price" class="form-control" type="number" min="0"  />
                                    </div>
                                    <span asp-validation-for="Price" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label asp-for="Quantity" class="form-label fw-bold">Số lượng</label>
                                    <input asp-for="Quantity" class="form-control" type="number" min="1"  />
                                    <span asp-validation-for="Quantity" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <div class="form-check">
                                <input asp-for="IsActive" class="form-check-input" id="isActive" />
                                <label asp-for="IsActive" class="form-check-label">Có sẵn để bán</label>
                            </div>
                        </div>

                        <div class="form-group mb-4">
                            <label asp-for="Images" class="form-label fw-bold">Tải ảnh lên</label>
                            <div class="image-upload-container">
                                <div class="custom-file-upload">
                                    <input type="file" id="imageUpload" name="Images" multiple accept="image/*" onchange="previewImages(this)" />
                                    <div class="file-upload-text">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                        <span>Kéo và thả hình ảnh hoặc nhấp để duyệt</span>
                                    </div>
                                </div>
                                <div id="image-preview-container" class="mt-3 row">
                                    <!-- Preview images will be shown here -->
                                </div>
                            </div>
                            <span asp-validation-for="Images" class="text-danger"></span>
                        </div>

                        <div class="form-group d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">Thêm</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        border-radius: 10px;
        overflow: hidden;
    }

    .card-header {
        border-bottom: none;
    }

    .form-label {
        margin-bottom: 0.5rem;
    }

    .form-select,
    .form-control {
        padding: 0.75rem;
        border-radius: 6px;
        border: 1px solid #ced4da;
    }

        .form-select:focus,
        .form-control:focus {
            border-color: #80bdff;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

    .btn-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

        .btn-primary:hover {
            background-color: #0b5ed7;
            border-color: #0a58ca;
        }

    /* Custom File Upload Styling */
    .custom-file-upload {
        border: 2px dashed #ced4da;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        position: relative;
        background-color: #f8f9fa;
        transition: all 0.3s ease;
    }

        .custom-file-upload:hover {
            border-color: #0d6efd;
            background-color: #f0f7ff;
        }

        .custom-file-upload input[type="file"] {
            opacity: 0;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

    .file-upload-text {
        color: #6c757d;
    }

        .file-upload-text i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }

    /* Preview image styling */
    .image-preview {
        position: relative;
        margin-bottom: 15px;
    }

        .image-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .image-preview .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            color: #dc3545;
        }

    /* Color preview for color select */
    .color-preview {
        display: inline-block;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        margin-right: 5px;
        vertical-align: middle;
    }
</style>

<script>
    let selectedFiles = []; // lưu tất cả ảnh được chọn

    function previewImages(input) {
        const previewContainer = document.getElementById('image-preview-container');

        // Thêm file mới vào selectedFiles
        const newFiles = Array.from(input.files);
        selectedFiles = selectedFiles.concat(newFiles);

        // Clear input để có thể chọn thêm ảnh lần nữa
        input.value = '';

        // Hiển thị lại toàn bộ ảnh trong selectedFiles
        previewContainer.innerHTML = "";

        selectedFiles.forEach((file, index) => {
            if (!file.type.startsWith('image/')) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const col = document.createElement('div');
                col.className = 'col-md-4 col-sm-6';

                const preview = document.createElement('div');
                preview.className = 'image-preview';

                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'shadow-sm';

                const removeBtn = document.createElement('div');
                removeBtn.className = 'remove-image';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';

                // Xử lý xóa ảnh khỏi danh sách
                removeBtn.onclick = function () {
                    selectedFiles.splice(index, 1);
                    previewImages({ files: [] }); // gọi lại để render lại preview
                };

                preview.appendChild(img);
                preview.appendChild(removeBtn);
                col.appendChild(preview);
                previewContainer.appendChild(col);
            };
            reader.readAsDataURL(file);
        });
    }


    // Add color preview beside color options
    document.querySelector('form').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);

        // Xóa phần file hiện có trong formData để tránh bị trùng
        formData.delete('Images');

        selectedFiles.forEach(file => {
            formData.append('Images', file);
        });

        fetch(this.action, {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.redirected) {
                window.location.href = response.url;  // Điều hướng theo redirect trả về từ server
            } else {
                // Xử lý lỗi hoặc phản hồi khác
                console.log("Not redirected");
            }
        }).catch(error => {
            console.error('Error:', error);
        });

    });
</script>